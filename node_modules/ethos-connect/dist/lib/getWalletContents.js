import{SUI_TYPE_ARG as U}from"@mysten/sui.js/utils";import{SuiClient as F}from"@mysten/sui.js/client";import{newBN as y,sumBN as K}from"./bigNumber.js";import{DEFAULT_NETWORK as G}from"./constants.js";import L from"./getDisplay.js";import{getKioskObjects as Y,isKiosk as $}from"./getKioskNFT.js";import E from"store2";const q=i=>i?i.indexOf("ipfs")===0?i.replace(/^ipfs:\/\//,"https://ipfs.io/ipfs/"):i:"",v={suiBalance:y(0),balances:{},nfts:[],tokens:{},objects:[]},z=async({address:i,network:N,existingContents:p,invalidPackageModifications:d})=>{try{const l=new F({url:N||G});if(!i)return v;let o=[];try{o=E.get("invalidPackages")??[],o=await(await fetch("https://raw.githubusercontent.com/EthosWallet/valid_packages/main/public/invalid_tokens.json")).json(),E.set("invalidPackages",o),d?.invalidPackageAdditions&&(o=o.concat(d.invalidPackageAdditions)),d?.invalidPackageSubtractions&&(o=o.filter(t=>!d.invalidPackageSubtractions.includes(t)))}catch(e){console.error(e)}const T=(await l.getAllBalances({owner:i})).filter(e=>!o.includes(e.coinType.split("::")[0]));let f=[],w,u,S=0,O=!1;for(;u!==null;){S+=1;const e=await l.getOwnedObjects({owner:i,options:{showType:!0,showOwner:!0,showContent:!0,showDisplay:!0},cursor:u});f=[...f,...e.data],O=e.hasNextPage,S>20?u=null:O&&w!==e.nextCursor?u=e.nextCursor??null:u=null}if(f.length===0)return p===v?null:v;const g=f.map(e=>e.data);for(const e of g)if(!!e&&$(e)){const t=await Y(l,e);for(const a of t)a.data&&g.push({...a.data,kiosk:e})}const x=[];let b=[];if(p?.objects&&p.objects.length>0)for(const e of g){if(!e)continue;const t=p?.objects.find(a=>typeof e=="object"?a.objectId===e.objectId&&a.version.toString()===e.version.toString():!1);t?x.push(t):b.push(e)}else b=g.filter(e=>!!e);if(b.length===0)return null;const W=b,_=x.concat(W);let P=y(0);const B=T.reduce((e,t)=>(e[t.coinType]=t,t.coinType===U&&(P=y(t.totalBalance)),e),{}),I=[],r={},D=[];for(const e of _){const{display:t,content:a}=e,{fields:A}=a?.dataType==="moveObject"?a:{fields:{}},s=A,n=L(t);try{const j=(e.type||"").split("<"),c=(j[1]||"").replace(/>/,""),m=j[0].split("::"),h=m[0],R=m[1],k=m[m.length-1];if(o.includes(h))continue;const C=q(n?.image_url??n?.img_url??n?.url??s?.url??s?.image_url??s?.img_url);D.push({...e,packageObjectId:h,moduleName:R,structName:k,name:n?.name??s?.name,description:n?.description??s?.description,imageUrl:C,display:n,fields:s,isCoin:k==="Coin"}),k==="Coin"?(r[c]||(r[c]={balance:0,coins:[]}),r[c].balance=K(r[c].balance,s.balance),r[c].coins.push({objectId:e?.objectId,type:e?.type,balance:y(s.balance),digest:e?.digest,version:e?.version,display:n})):C&&I.push({type:e.type??"Unknown",packageObjectId:h,moduleName:R,structName:k,chain:"Sui",address:e?.objectId,objectId:e?.objectId,name:n?.name??s?.name,description:n?.description??s?.description,imageUrl:C,link:n?.link,creator:n?.creator,projectUrl:n?.project_url,display:n,fields:s,links:{Explorer:`https://explorer.sui.io/objects/${e.objectId}`},kiosk:e.kiosk})}catch(j){console.log("Error retrieving object",e,j)}}return{suiBalance:P,balances:B,tokens:r,nfts:I,objects:D,hasNextPage:O,nextCursor:w??void 0}}catch(l){return console.log("Error retrieving wallet contents",l),null}};var ge=z;export{ge as default,q as ipfsConversion};
